name: One-time backfill PE/EPS history (SPY/QQQ)

concurrency:
  group: one_time_backfill_pe_eps
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      tickers:
        description: "Space-separated tickers (e.g. 'SPY QQQ')"
        required: true
        default: "SPY QQQ"
      simulate_pre_etf:
        description: "Simulate pre-ETF history via ^GSPC/^NDX scaling"
        required: true
        type: boolean
        default: true
      create_pr:
        description: "Create a PR with updated DB + charts (otherwise artifact only)"
        required: true
        type: boolean
        default: false
      confirm:
        description: "Safety check: type BACKFILL to run"
        required: true
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Check confirm string
        run: |
          set -euo pipefail
          if [[ "${{ inputs.confirm }}" != "BACKFILL" ]]; then
            echo "Refusing to run. Set confirm=BACKFILL to proceed."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal dependencies (avoid full requirements.txt)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install pandas numpy requests lxml beautifulsoup4 html5lib yfinance "bokeh==3.8.2"

      - name: Verify DB exists
        run: |
          set -euo pipefail
          if [[ ! -f "Stock Data.db" ]]; then
            echo "ERROR: Stock Data.db not found at repo root."
            echo "This workflow assumes the DB lives at: ./Stock Data.db"
            ls -la
            exit 1
          fi

      - name: Run one-time backfill
        run: |
          set -euo pipefail
          TICKERS="${{ inputs.tickers }}"
          EXTRA=""
          if [[ "${{ inputs.simulate_pre_etf }}" == "true" ]]; then
            EXTRA="--simulate-pre-etf"
          fi
          python backfill_index_pe_eps.py --tickers $TICKERS $EXTRA

      - name: Regenerate valuation chart assets
        run: |
          set -euo pipefail
          TICKERS="${{ inputs.tickers }}"
          for tk in $TICKERS; do
            echo "Rebuilding index valuation bundle for $tk"
            python index_growth_charts.py "$tk"
          done

      - name: Upload output artifact (DB + charts)
        uses: actions/upload-artifact@v4
        with:
          name: pe-eps-backfill-output
          if-no-files-found: error
          path: |
            Stock Data.db
            charts/

      - name: Create PR (optional)
        if: ${{ inputs.create_pr == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "One-time backfill PE/EPS history (${{ inputs.tickers }})"
          title: "One-time backfill PE/EPS history (${{ inputs.tickers }})"
          add-paths: |
            Stock Data.db
            charts/**
          body: |
            This PR was generated by the manual workflow:
            .github/workflows/one_time_backfill_pe_eps.yml

            It runs:
            - python backfill_index_pe_eps.py
            - python index_growth_charts.py for each ticker
          branch: backfill-pe-eps-${{ github.run_id }}
          delete-branch: true
